
## 1. 项目概述 (Executive Summary)

**Fragile Express** 是一款利用 CSC8503 框架底层物理引擎构建的 3D 动作解谜游戏。

- **核心体验**: **"Everything is Physics" (万物皆物理)**。没有脚本化的移动，只有力、冲量、动量和碰撞。
    
- **Part A (单人 - 50分)**: 侧重于物理引擎的展示（碰撞检测与响应）、基础 AI 状态机和易碎品机制。
    
- **Part B (多人 - 50分)**: 侧重于网络同步、协同物理机制（双人搬运）、寻路算法 (A*) 和高级 AI 行为。
    

## 2. 核心机制详解与实现路径 (Core Mechanics & Implementation)

这是之前被简化的部分。以下是每个机制的详细逻辑和代码实现方向。

### 2.1 动力学玩家控制器 (Dynamics Player Controller)

玩家不是移动坐标，而是驾驶一个物理球体。

- **机制描述**:
    
    - **移动**: 使用 WASD 键根据摄像机朝向施加物理力 (Force)。
        
    - **阻尼 (刹车)**: 必须模拟空气阻力或地面摩擦，否则球体会无限加速或永不停止。
        
    - **跳跃**: 施加瞬间向上的冲量 (Impulse)。
        
- **💻 代码实现路径**:
    
    1. **类**: `TutorialGame.cpp` -> `UpdateGame()`
        
    2. **输入读取**:
        
        ```
        if (Window::GetKeyboard()->KeyDown(KeyboardKeys::W))
            force += camera->GetForward() * speed;
        ```
        
    3. **物理应用**:
        
        - 调用 `playerObject->GetPhysicsObject()->AddForce(force)`。
            
    4. **阻尼逻辑 (关键)**:
        
        - 在 `PhysicsObject::Update()` 或游戏逻辑中：
            
        - `LinearVelocity = LinearVelocity * 0.95f;` (每帧衰减 5%)。
            

### 2.2 抓取与约束系统 (Grab & Constraint System)

这是实现“搬运”和“拖拽”的底层技术。

- **机制描述**:
    
    - 玩家按住 `Shift` 键时，向摄像机前方发射射线 (Raycast)。
        
    - 如果射线击中一个带有 `Movable` 标签的物体，在玩家和击中点之间创建一个 **Point-to-Point Constraint (点对点约束)**。
        
    - 当玩家松开 `Shift` 键，销毁该约束。
        
- **💻 代码实现路径**:
    
    1. **射线检测**:
        
        - 使用 `CollisionDetection::RayIntersection(ray, world)`。
            
    2. **创建约束**:
        
        - 实例化 `PositionConstraint(player, targetObject, maxDistance)`。
            
        - 调用 `world->AddConstraint(newConstraint)`。
            
    3. **销毁**:
        
        - 维护一个 `Constraint* currentGrab` 指针。松开按键时调用 `world->RemoveConstraint(currentGrab)`。
            

### 2.3 易碎系统 (Impulse-Based Fragility) —— _Part A 核心_

展示 `Collision Resolution` 的计算结果。

- **机制描述**:
    
    - 监听碰撞事件。
        
    - **伤害公式**: $Damage = (ImpulseMagnitude - SafeThreshold) \times FragilityFactor$。
        
    - 如果碰撞太猛烈（如高空坠落或被高速撞击），货物 HP 减少，颜色变红。
        
- **💻 代码实现路径**:
    
    1. **碰撞回调**:
        
        - 在 `GameObject` 类中添加虚函数 `OnCollisionBegin(GameObject* other)`.
            
    2. **数据获取**:
        
        - 在 `PhysicsSystem` 计算出 Impulse 后，将其传递给对象。
            
    3. **逻辑判断**:
        
        ```
        // 伪代码
        void FragileItem::OnCollisionBegin(GameObject* other) {
             float impulse = physicsObject->GetLastCollisionImpulse();
             if (impulse > 10.0f) {
                 health -= (impulse - 10.0f);
                 renderObject->SetColour(Color::Red); // 视觉反馈
             }
        }
        ```
        

### 2.4 多人重物协同 (Co-op Heavy Lifting) —— _Part B 核心_

利用物理质量切换强制玩家合作。

- **机制描述**:
    
    - **对象**: 紫色巨型方块。
        
    - **默认状态**: `InverseMass = 0` (物理引擎视为无限重/静态物体)。
        
    - **激活状态**: 只有当服务器检测到 **Player 1** 和 **Player 2** 同时对其施加了约束（都抓住了它），才将其 `InverseMass` 设为 `0.5` (可移动)。
        
    - **断开惩罚**: 如果任一玩家松手，质量瞬间变回无限大。惯性会导致还在移动的另一名玩家被猛烈扯回或弹飞。
        
- **💻 代码实现路径**:
    
    1. **逻辑位置**: 仅在 **Server** 端运行 (`NetworkedGame::UpdateAsServer`)。
        
    2. **状态检查**:
        
        - 遍历该物体的连接计数器。
            
        - `if (grabCount >= 2) object->SetInverseMass(0.5f);`
            
        - `else object->SetInverseMass(0.0f);`
            
    3. **网络同步**:
        
        - 通过 `Packet_EntityState` 将物体的质量状态或位置同步给客户端。
            

## 3. 关卡设计：物理游e Level Flow)
乐场 (Th
地图为一个长条形、分为四个区域的统一场景。

### 区域 1: 保龄球馆 (The Bowling Alley) [Part A]

- **类型**: 教学区。
    
- **内容**:
    
    - 高台出生点 + 长斜坡。
        
    - 底部堆放 10 个轻质方块（保龄球瓶）。
        
    - **任务**: 冲下斜坡撞飞方块，然后**推**（利用物理碰撞）一个方块压住地面按钮，打开大门。
        
    - 在此处拾取红色的易碎货物。
        

### 区域 2: 冰原挑战 (The Slippery Slope) [Part A]

- **类型**: 物理参数展示区。
    
- **内容**:
    
    - 地面摩擦力极低 (`Friction = 0.1`)。
        
    - **AI 守卫**: 红色胶囊体，在两个点之间巡逻。
        
    - **任务**: 玩家需要护送易碎品滑过冰面。由于很难刹车，容易撞墙碎裂；同时需要利用冰面惯性快速滑过守卫的视野区。
        
    - **机关**: 绿色跳板 (Trigger)，踩上去施加巨大向上力。
        

### 区域 3: 禁忌迷宫 (The Forbidden Maze) [Part B]

- **类型**: 寻路与生存区。
    
- **内容**: 复杂的树篱迷宫。
    
- **双重 AI 威胁 (Server控制)**:
    
    1. **愤怒的大鹅**: 使用 __A_ 算法_* 寻路，死咬住最近的玩家不放。
        
    2. **敌对信使**: 在迷宫中游荡，捡起地上的球（石头），朝玩家扔过来。
        
- **合作任务**:
    
    - 在此区域拾取紫色重物。
        
    - **诱饵战术**: 一名玩家必须空手去引开大鹅和信使，另一名玩家趁机和队友汇合搬运。
        
    - **双子锁**: 出口门需要两人分头踩两个相距很远的按钮才能打开。
        

### 区域 4: 熔岩试炼 (The Magma Trial) [Part B]

- **类型**: 终极物理平衡。
    
- **内容**:
    
    - 跨越岩浆的巨大**物理跷跷板**。
        
    - **任务**: 两人抬着重物走过跷跷板。
        
    - **挑战**: 必须保持速度绝对同步。如果一人走太快，跷跷板重心偏移倾斜，所有人掉入岩浆重置。
        
    - **终点**: 通过后将重物放入绿色光柱，上传分数。
        

## 4. AI 系统详解 (Artificial Intelligence)

### 4.1 巡逻守卫 (Guard) - _Simple State Machine_

- **Patrol**: `position += (target - position).Normalised() * dt`。到达节点后切换目标。
    
- **Chase**: 射线检测 (Raycast) 击中玩家 -> 切换状态 -> 直接向玩家施加力。
    

### 4.2 愤怒大鹅 (Goose) - _Pathfinding_

- **Grid 生成**: 将迷宫地图划分为 10x10 或 20x20 的网格节点。
    
- __A_ 算法_*: `CalculatePath(Start, End)` 返回 `vector<Vector3> waypoints`。
    
- **移动**: 鹅沿着 waypoints 移动，从而绕过墙壁。
    

### 4.3 敌对信使 (Rival) - _Advanced Behavior_

- **武器系统**: 检测范围内标签为 `Stone` 的物体。
    
- **攻击逻辑**:
    
    1. 移动到石头处 -> 建立约束 (捡起)。
        
    2. 移动到能看到玩家的位置。
        
    3. 断开约束 -> 对石头施加 `AddForce((PlayerPos - StonePos) * 500.0f)`。
        

## 5. 网络架构 (Networking Architecture)

- **拓扑**: Client-Server (基于 ENet)。
    
- **协议**:
    
    - `Packet_PlayerInput`: 客户端发送按键 -> 服务器模拟物理。
        
    - `Packet_WorldState`: 服务器每秒 20 次广播所有物体 (ID, Pos, Rot) -> 客户端插值渲染。
        
    - `Packet_GameEvent`: 分数更新、门开启、玩家死亡。
        
- **高分榜**:
    
    - Server 维护 `std::vector<int> highScores`。
        
    - 客户端按 `TAB` 请求数据，服务器发送数据包更新 UI。
        

## 6. 22天极限开发日程 (Implementation Roadmap)

### **阶段一：物理核心 (Day 1 - 7)** —— _Part A 基础_

- **Day 1-2**: 搭建项目，实现 **WASD 力控制移动** 和 **阻尼**。
    
- **Day 3-5**: **重中之重**: 实现 `CollisionDetection` (Sphere/AABB/OBB) 和 `CollisionResolution` (冲量反弹)。
    
- **Day 6-7**: 搭建“保龄球馆”和“冰原”，测试物理参数 (摩擦力、弹性)。实现抓取约束。
    

### **阶段二：单人逻辑完善 (Day 8 - 12)** —— _Part A 交付_

- **Day 8**: 编写易碎品逻辑 (Impulse -> Damage)。
    
- **Day 9**: 实现巡逻守卫 AI (状态机) 和射线检测。
    
- **Day 10**: 实现按钮、门和跳板逻辑。
    
- **Day 11-12**: 制作 UI，整合 Part A 关卡，**录制演示视频 (防灾备份)**。
    

### **阶段三：网络与 AI (Day 13 - 18)** —— _Part B 核心_

- **Day 13-14**: 搭建 ENet Server，实现位置同步。编写重物协同逻辑 (`InverseMass` 切换)。
    
- **Day 15**: 实现网格生成 (Grid Generation) 和 A* 寻路算法。
    
- **Day 16**: 实现大鹅 AI (集成寻路)。
    
- **Day 17-18**: 实现敌对信使 AI (捡石头/扔石头) 和高分榜逻辑。
    

### **阶段四：打磨与提交 (Day 19 - 22)**

- **Day 19**: 整合 Area 3 和 Area 4，放置双人机关。
    
- **Day 20**: 网络压力测试 (测试延迟下的跷跷板平衡性)。
    
- **Day 21**: 代码清理，添加注释。
    
- **Day 22**: 截图，录制最终视频，打包提交。