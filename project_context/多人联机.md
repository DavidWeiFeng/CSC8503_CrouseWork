以下是整理好的 Markdown 格式文档，适合用于 GitHub Readme 或技术设计文档。

---

# 多人网络游戏系统设计文档 (System Architecture & Design)

## 1. 系统架构概览

采用 **C/S (Client-Server)** 架构，以 **Server Authoritative (服务器权威)** 为核心原则。

*   **Server (权威端):** 负责物理模拟、游戏逻辑仲裁（如双人搬运判定）、AI 运行、高分榜维护。所有的物体位置和状态由服务器计算并广播。
*   **Client (哑终端):** 负责渲染场景、采集玩家输入（WASD/Space/Grab）并发送给服务器。客户端不进行物理模拟，仅对收到的状态进行插值平滑显示。

### 1.1 核心类映射

| 类名              | 职责                                | 现有状态 | 扩展需求                                |
| :---------------- | :---------------------------------- | :------- | :-------------------------------------- |
| **NetworkedGame** | 游戏主循环，管理 Server/Client 实例 | 已存在   | 需整合高分榜逻辑、双人搬运判定          |
| **GameServer**    | 处理连接、广播 Snapshot、接收输入   | 已存在   | 需处理高分榜请求、自定义输入包          |
| **GameClient**    | 发送输入、接收 Snapshot、插值       | 已存在   | 需处理高分榜接收、UI 显示               |
| **NetworkObject** | 序列化/反序列化 GameObject 状态     | 已存在   | 需完善 Transform/Velocity 同步逻辑      |
| **NetworkPlayer** | 玩家实体                            | 已存在   | 需关联 PlayerID，服务器根据 ID 应用输入 |

---

## 2. 功能详细设计

### 2.1 菜单与连接系统 (Menu & Connection)

**目标:** 允许玩家输入 IP 加入游戏或作为主机创建游戏。

*   **UI 交互逻辑:**
    1.  扩展 `TutorialGame::HandleStartMenu`。
    2.  **Host 模式:** 选择 `[1] Start Server` -> 调用 `NetworkedGame::StartAsServer()`。
    3.  **Client 模式:** 选择 `[2] Join Game` -> 进入二级菜单（或控制台输入） -> 输入 IP (默认 127.0.0.1) -> 调用 `NetworkedGame::StartAsClient()`。

*   **IP 输入方案 (简易版):**
    *   在菜单中提供预设 IP (127.0.0.1) 选项。
    *   或者利用 `std::cin` (如果在 Window 模式) / Debug UI 虚拟键盘输入 IP 字符串。

### 2.2 高分榜系统 (High Score System)

**目标:** 持久化存储分数，客户端按需请求显示。

*   **数据结构:**
    在 `NetworkedGame` 中维护：
    ```cpp
    struct ScoreEntry {
        char name[32]; // 玩家名字
        int score;
    };
    
    std::vector<ScoreEntry> serverHighScores;
    ```

*   **文件 I/O (Server 端):**
    *   **Save:** 游戏结束或玩家断开时，将 `serverHighScores` 写入 `HighScores.json` (或 .txt)。
    *   **Load:** 服务器启动时读取文件。

*   **网络同步流程:**
    1.  **Request:** 客户端按下 `F3` (或其他键) -> 发送 `HighScore_Request` 包。
    2.  **Response:** 服务器收到请求 -> 序列化 `serverHighScores` -> 发送 `HighScore_Data` 包。
    3.  **Display:** 客户端收到数据 -> 更新本地缓存 -> 在 `DrawOneFrame` 中绘制 UI 覆盖层。

### 2.3 双人协作搬运系统 (Coop Lifting)

**目标:** 实现“两名玩家同时抓取才能移动重物”的逻辑。

*   **核心逻辑 (Server 端 `UpdateGame` 中执行):**
    *   **重物标记:** 在 GameObject 中添加标记或特定 Tag (`"HeavyObject"`).
    *   **状态判定:**
        1.  遍历所有 `"HeavyObject"`。
        2.  检测当前有多少个 `NetworkPlayer` 正在与该物体发生 `"Grab"` (抓取约束存在)。
        3.  **判定:**
            *   `GrabCount >= 2`: 设置 `PhysicsObject::SetInverseMass(1.0f)` (可移动)。
            *   `GrabCount < 2`: 设置 `PhysicsObject::SetInverseMass(0.0f)` (无限重/静态)。

*   **客户端表现:**
    *   当物体变轻被抬起时，服务器广播的位置更新会让客户端看到物体移动。
    *   *(可选)* 视觉反馈：当满足双人条件时，物体高亮颜色变化。

---

## 3. 网络协议设计 (Packet Definitions)

需在 `NetworkBase.h` 或 `NetworkedGame.h` 中扩展以下协议：

### 3.1 消息类型 (Enum Extension)

```cpp
enum BasicNetworkMessages {
    // ... 现有类型 ...
    Player_Input = 10,    // 客户端 -> 服务器：按键状态
    HighScore_Request,    // 客户端 -> 服务器：请求高分榜
    HighScore_Data,       // 服务器 -> 客户端：高分榜数据
    Coop_State_Update     // (可选) 服务器 -> 客户端：通知物体是否被激活
};
```

### 3.2 包结构定义

#### 1. 玩家输入包 (PlayerInputPacket)

```cpp
struct PlayerInputPacket : public GamePacket {
    int     playerID;
    bool    keyW;
    bool    keyA;
    bool    keyS;
    bool    keyD;
    bool    keySpace;  // 跳跃
    bool    keyGrab;   // 抓取
    float   cameraYaw; // 用于服务器计算移动方向

    PlayerInputPacket() {
        type = BasicNetworkMessages::Player_Input;
        size = sizeof(PlayerInputPacket) - sizeof(GamePacket);
    }
};
```

#### 2. 高分榜数据包 (HighScorePacket)

*注：由于 Packet 大小限制，如果数据较多可能需要分片，这里采用简化版（发送前 Top 5）。*

```cpp
struct HighScorePacket : public GamePacket {
    int count;
    int scores[5];
    // 名字简化处理，或者只发分数，具体视实现复杂度定
    // char names[5][32];

    HighScorePacket() {
        type = BasicNetworkMessages::HighScore_Data;
        size = sizeof(HighScorePacket) - sizeof(GamePacket);
    }
};
```

---

## 4. 实现步骤规划 (Roadmap)

### Phase 1: 基础连接与输入同步
- [ ] 完善 `StartAsServer` / `StartAsClient` 流程。
- [ ] 实现 `PlayerInputPacket` 结构体。
- [ ] 服务器端实现：接收 Input 包 -> 应用力(Force)到对应的 `NetworkPlayer`。
- [ ] **验证：** 客户端按 W，服务器端球体移动，客户端看到球体移动同步。

### Phase 2: 高分榜系统
- [ ] 实现 `HighScoreManager` 类 (负责 Load/Save)。
- [ ] 实现 `ReceivePacket` 中对 `HighScore_Request` 的处理逻辑。
- [ ] 客户端实现 UI 绘制逻辑。

### Phase 3: 双人协作逻辑
- [ ] 场景中放置一个 Tag 为 `"HeavyCrate"` 的大立方体。
- [ ] 在 `NetworkedGame::UpdateAsServer` 中添加 `CheckCoopConditions()` 函数。
- [ ] 实现抓取计数器与 Physics Mass 切换逻辑。

### Phase 4: 菜单整合
- [ ] 修改 `HandleStartMenu` 支持 IP 输入与模式选择。